/*
* Copyright 2017 Seven Spikes Ltd. All rights reserved. (http://www.nop-templates.com)
* http://www.nop-templates.com/t/licensinginfo
*/

function UpdateCondition(){var e=sevenSpikesCore.getHiddenValFromDom("#update-condition-url"),t=sevenSpikesCore.getHiddenValFromDom("#condition-id"),o=sevenSpikesCore.getHiddenValFromDom("#condition #ConditionName"),n=sevenSpikesCore.getHiddenValFromDom("#condition #DefaultConditionValue"),i={ConditionName:o,Active:!!$("#condition #Active").attr("checked"),DefaultConditionValue:n,conditionId:t};addAntiForgeryToken(i),$.ajax({cache:!1,async:!1,type:"POST",data:i,url:e,success:function(){},error:function(e,t,o){alert("Updating condition failed.")}})}function UpdateDefaultConditionStatement(){var e=sevenSpikesCore.getHiddenValFromDom("#update-default-condition-group-statement-url"),t={conditionId:sevenSpikesCore.getHiddenValFromDom("#condition-id"),defaultConditionStatementValue:$("#DefaultConditionValue").find(":selected").val()};addAntiForgeryToken(t),$.ajax({cache:!1,async:!1,type:"POST",data:t,url:e,success:function(){},error:function(e,t,o){alert("Updating condition default group statement failed.")}})}function DisplayExistingConditions(){var e=$.parseJSON(sevenSpikesCore.getHiddenValFromDom("#condition-groups"));if(null!=e)for(var t=0;t<e.length;t++)AddConditionGroup(e[t])}function AddConditionGroup(e){if(e&&0!=e)AddConditionGroupGridHtml(e);else if(""==(e=CreateConditionGroupAndAddConditionGroupGridHtml()))return;addKendoGridForConditionGroup(e)}function addKendoGridForConditionGroup(e){var t="condition-group-grid-"+e,o=sevenSpikesCore.getHiddenValFromDom("#read-condition-group-url"),n=sevenSpikesCore.getHiddenValFromDom("#update-condition-statement-url"),i=sevenSpikesCore.getHiddenValFromDom("#destroy-condition-statement-url"),d=sevenSpikesCore.getHiddenValFromDom("#create-condition-statement-url"),r={},a=0,l=new kendo.data.DataSource({transport:{type:"json",read:{url:o,cache:!1,dataType:"json",data:addAntiForgeryToken},update:{url:n,type:"POST",dataType:"json",data:addAntiForgeryToken},destroy:{url:i,cache:!1,dataType:"json",data:addAntiForgeryToken},create:{url:d,type:"POST",dataType:"json",data:addAntiForgeryToken},parameterMap:function(t,o){return"update"===o||"create"===o?addAntiForgeryToken(r):"read"===o?addAntiForgeryToken({conditionGroupId:e}):"destroy"===o?addAntiForgeryToken({conditionStatementId:a}):void 0}},batch:!0,pageSize:30,schema:{model:{id:"Id",fields:{ConditionType:{type:"text"},ConditionTypeId:{type:"number"},ConditionPropertyValue:{type:"number"},ConditionPropertyText:{type:"text"},OperatorTypeText:{type:"text"},OperatorTypeValue:{type:"number"},Text:{type:"text"},Value:{type:"text"}}}}});$("#"+t).kendoGrid({dataSource:l,sortable:!0,editable:{mode:"popup",template:kendo.template($("#popup_editor").html()),window:{animation:!1,width:400}},edit:function(e){var t=e.model;void 0!=t.ConditionType&&void 0!=t.ConditionPropertyValue&&void 0!=t.OperatorTypeValue&&void 0!=t.Value&&($("#condition-type").attr("data-editValue",t.ConditionTypeId),$("#condition-property").attr("data-editValue",t.ConditionPropertyValue),$("#condition-operator").attr("data-editValue",t.OperatorTypeValue),$("#condition-value").attr("data-editValue",t.Value),$("#condition-num-value").attr("data-editValue",t.Value),$("#condition-text-value").attr("data-editValue",t.Value))},save:function(t){r.ConditionGroupId=e,r.ConditionTypeId=$("#condition-type").val(),r.ConditionPropertyValue=$("#condition-property").val(),r.OperatorTypeValue=$("#condition-operator").val();var o=$("#condition-value").parents(".k-dropdown").css("display"),n=$("#condition-num-value").parents(".k-numerictextbox").css("display"),i=$("#condition-text-value").css("display");if(o&&"none"==o?n&&"none"==n?i&&"none"==i||(r.Value=$("#condition-text-value").val()):r.Value=$("#condition-num-value").val():r.Value=$("#condition-value").val(),void 0!=t.model.ConditionType)for(var d=l.data(),a=0;a<d.length;a++)d[a].Id==t.model.Id&&(r.Id=t.model.Id,d[a].dirty=!0)},remove:function(e){if(void 0!=e.model.Id&&""!=e.model.Id)for(var t=l.data(),o=0;o<t.length;o++)t[o].Id==e.model.Id&&(a=e.model.Id,t[o].dirty=!0)},toolbar:["create","destroy"],columns:[{field:"Id",title:"Id",width:100,hidden:!0},{field:"ConditionType",title:"Type",width:100},{field:"ConditionPropertyText",title:"Property",width:100},{field:"OperatorTypeText",title:"OperatorType",width:100},{field:"Text",title:"Text",width:250},{field:"Value",title:"Value",width:200,hidden:!0},{command:["edit","destroy"],title:"&nbsp;",width:"150px"}]})}function DeleteConditionGroup(e,t){var o=sevenSpikesCore.getHiddenValFromDom("#delete-condition-group-url"),n={conditionGroupId:e};addAntiForgeryToken(n),$.ajax({cache:!1,type:"POST",data:n,url:o,success:function(){$("#"+t).data("kendoGrid").destroy(),$("#"+t).parent().remove()},error:function(e,t,o){alert("Deleting condition group failed.")}})}function AddViewModel(){var e=kendo.observable({typeSource:GetConditionTypes(),selectedType:null,selectedProperty:null,selectedOperator:null,selectedValue:null});e.selectedType=SetSelectedConditionType(e.typeSource),e.selectedProperty=SetSelectedConditionProperty(e.selectedType),e.selectedOperator=SetSelectedOperatorType(e.selectedProperty),e.selectedValue=function(){var e,t=$("#condition-value").parents(".k-dropdown").css("display"),o=$("#condition-num-value").parents(".k-numerictextbox").css("display"),n=$("#condition-text-value").css("display");return t&&"none"==t?o&&"none"==o?n&&"none"==n||(e=$("#condition-text-value").attr("data-editValue")):e=$("#condition-num-value").attr("data-editValue"):e=$("#condition-value").attr("data-editValue"),void 0!=e&&""!=e?e:null},kendo.bind($("#editor"),e)}function SetSelectedConditionType(e){var t=$("#condition-type").attr("data-editValue");if(void 0!=t&&""!=t)for(var o=0;o<e.length;o++)if(e[o].ConditionTypeId==t)return e[o];return null}function SetSelectedConditionProperty(e){var t=$("#condition-property").attr("data-editValue");if(void 0!=t&&""!=t)for(var o=0;o<e.ConditionProperties.length;o++)if(e.ConditionProperties[o].ConditionPropertyValue==t)return e.ConditionProperties[o];return null}function SetSelectedOperatorType(e){var t=$("#condition-operator").attr("data-editValue");if(void 0!=t&&""!=t)for(var o=0;o<e.Operators.length;o++)if(e.Operators[o].OperatorTypeValue==t)return e.Operators[o];return null}function GetConditionTypes(){var e=sevenSpikesCore.getHiddenValFromDom("#get-condition-type-url"),t={availableConditionTypesIds:sevenSpikesCore.getHiddenValFromDom("#available-condition-types")};addAntiForgeryToken(t);var o;return $.ajax({cache:!1,async:!1,type:"POST",data:t,url:e,success:function(e){o=e},error:function(e,t,o){alert("Retrieving condition types failed.")}}),o}function CreateConditionGroupAndAddConditionGroupGridHtml(){var e=sevenSpikesCore.getHiddenValFromDom("#create-condition-group-url"),t=sevenSpikesCore.getHiddenValFromDom("#condition-id");if(""==e||""==t)return 0;var o={conditionId:t};addAntiForgeryToken(o);var n="";return $.ajax({cache:!1,async:!1,type:"POST",data:o,url:e,success:function(e){AddConditionGroupGridHtml(n=e)},error:function(e,t,o){alert("Creating new condition group failed.")}}),n}function AddConditionGroupGridHtml(e){var t='<div><div class="condition-group-grid" id="'+("condition-group-grid-"+e)+'" data-conditionGroupId="'+e+'"></div><div class="group-dependancy-text"><p>--OR--</p></div></div>';$("#condition-groups-wrapper").append(t)}$(document).ready(function(){DisplayExistingConditions(),$("a.add-condition-group").click(function(){AddConditionGroup()}),$(".k-grid-toolbar a.k-grid-delete").livequery("click",function(){var e=$(this).closest(".condition-group-grid");if(void 0!=e){var t=$(e).attr("data-conditionGroupId"),o=$(e).attr("id");void 0!=t&&void 0!=o&&DeleteConditionGroup(t,o)}}),$("#condition #ConditionName, #condition #Active").change(function(){UpdateCondition()}),$("#DefaultConditionValue").change(function(){UpdateDefaultConditionStatement()})}),$("#editor").livequery(function(){AddViewModel()}),$(window).unload(function(){var e=sevenSpikesCore.getHiddenValFromDom("#delete-unused-condition-groups-url"),t={conditionId:sevenSpikesCore.getHiddenValFromDom("#condition-id")};addAntiForgeryToken(t),$.ajax({cache:!1,async:!1,type:"POST",data:t,url:e,success:function(){},error:function(e,t,o){alert("Deleting condition failed.")}})});